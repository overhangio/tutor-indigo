<%page expression_filter="h"/>
<%!
from futurex_openedx_extensions.helpers.tenants import get_config_current_request
from django.utils.translation import get_language
from django.conf import settings
from lms.djangoapps.branding import api as branding_api


def get_course_categories_config():
    """
    Get course categories from tenant configuration.
    Returns a dict with 'categories' and 'sorting' keys.
    """
    config_key = getattr(settings, 'FX_COURSE_CATEGORY_CONFIG_KEY', 'course_categories')
    config_value = get_config_current_request([config_key])
    if not config_value:
        return {'categories': {}, 'sorting': []}
    result = config_value['values'].get(config_key, {})
    if not result or not isinstance(result, dict):
        return {'categories': {}, 'sorting': []}
    return {
        'categories': result.get('categories', {}),
        'sorting': result.get('sorting', []),
    }


def get_course_categories_list():
    """
    Get course categories configuration for the current tenant.
    Returns a list of category dicts with 'id', 'label', and 'courses' keys,
    sorted according to the tenant's sorting preference.
    """
    config = get_course_categories_config()
    categories = config.get('categories', {})
    sorting = config.get('sorting', [])

    # Build ordered list of categories
    ordered_categories = []
    for cat_id in sorting:
        if cat_id in categories:
            cat_data = categories[cat_id]
            ordered_categories.append({
                'id': cat_id,
                'label': cat_data.get('label', {}),
                'courses': cat_data.get('courses', []),
            })

    # Add any categories not in sorting list
    for cat_id, cat_data in categories.items():
        if cat_id not in sorting:
            ordered_categories.append({
                'id': cat_id,
                'label': cat_data.get('label', {}),
                'courses': cat_data.get('courses', []),
            })

    return ordered_categories
%>

<%def name="br(text)" buffered="True"><%
    # Escape angle brackets for HTML except for <br> tags
    return text.replace('<', '&lt;').replace('>', '&gt;').replace('&lt;br&gt;', '<br>').replace('&lt;strong&gt;', '<strong>').replace('&lt;/strong&gt;', '</strong>')
%></%def>

<%def name="get_fx_config_value(key, default_value='')" buffered="True"><%
    config_value = get_config_current_request([key])
    if not config_value:
        return default_value
    result = config_value['values'].get(key, default_value)
    if result is None:
        result = default_value
    return result
%></%def>

<%def name="fx_supported_languages()" buffered="True"><%
    allowed_languages = getattr(settings, 'FX_THEME_ALLOWED_LANGUAGES', None)
    if not allowed_languages or not isinstance(allowed_languages, dict):
        allowed_languages = {
            'ar': 'العربية',
            'en': 'English',
            'fr': 'Français',
        }
    return allowed_languages
%></%def>

<%def name="t(config_dict_by_lang)" buffered="True"><%
    if not config_dict_by_lang or not isinstance(config_dict_by_lang, dict):
        return ''

    allowed_languages = list(fx_supported_languages().keys())
    language_code = get_language()
    if language_code in allowed_languages:
        selected_language = [language_code] + allowed_languages
    else:
        selected_language = allowed_languages
    for lang_code in selected_language:
        result = config_dict_by_lang.get(lang_code, '')
        if result:
            return result
    return ''
%></%def>

<%def name="get_all_fx_section_names()" buffered="True"><%
    return [
        'hero_section_v1',
        'two_columns_v1',
        'side_image_v1',
        'featured_courses_v1',
        'static_metrics_section_v1',
        'live_metrics_section_v1',
        'faq_section_v1',
        'paragraph_section_v1',
    ]
%></%def>

<%def name="get_all_fx_page_names()" buffered="True"><%
    return {
        'home': '',
        'courses': 'courses',
        'about-us': 'about',
        'contact-us': 'contact',
        'blog': 'blog',
        'donate': 'donate',
        'terms': 'tos',
        'privacy': 'privacy',
        'help': 'help',
        'faq': 'faq',
        'jobs': 'jobs',
        'news': 'news',
        'press': 'press',
        'media-kit': 'media-kit',
    }
%></%def>

<%def name="get_fx_link_sections(declared_link_sections)" buffered="True"><%
    link_sections = []

    valid_pages = get_all_fx_page_names()
    declared_valid_custom_pages = get_fx_config_value('custom_pages', default_value=[])
    valid_custom_pages = {
        _page['key']: _page['url_slug'] for _page in declared_valid_custom_pages if _page.get('key') and _page.get('url_slug')
    }

    for link_section in declared_link_sections:
        page = link_section.get('page', '')
        if page in valid_pages:
            page_type = 'page'
        elif page == 'external_link' and link_section.get('custom_url'):
            page_type = 'url'
        elif page.replace('-', '_') in valid_custom_pages:
            page_type = 'custom'
        else:
            page_type = 'invalid'

        if page_type == 'page':
            link_section['link'] = f'/{valid_pages[page]}'
        elif page_type == 'url':
            link_section['link'] = link_section['custom_url']
        elif page_type == 'custom':
            url_slug = valid_custom_pages[page.replace('-', '_')]
            link_section['link'] = f'/p/{url_slug}'
        else:
            page_type = 'invalid'

        if page_type != 'invalid':
            link_section['new_tab'] = 'target="_blank" rel="noopener"' if link_section.get('new_tab') else ''
            link_sections.append(link_section)

    return link_sections
%></%def>


<%def name="get_fx_social_media_links(declared_social_media_links)" buffered="True"><%
    social_media_links = []

    for f_link in declared_social_media_links:
        if f_link.get('value') and f_link.get('provider'):
            social_media_links.append(f_link)

    return social_media_links
%></%def>


<%def name="fx_get_logo_image_url()" buffered="True"><%
    logo_image_url = get_fx_config_value('logo_image_url', default_value='')
    if not logo_image_url:
        logo_image_url = branding_api.get_logo_url(is_secure)

    return logo_image_url
%></%def>


<%def name="fx_random_string(length=8)" buffered="True"><%
    import random
    import string
    return ''.join(random.choices(string.ascii_letters + string.digits, k=length))
%></%def>


<%def name="get_fx_course_categories()" buffered="True"><%
    """
    Get course categories configuration for the current tenant.
    Returns a list of category dicts with 'id', 'label', and 'courses' keys,
    sorted according to the tenant's sorting preference.
    """
    config = get_course_categories_config()
    categories = config.get('categories', {})
    sorting = config.get('sorting', [])

    # Build ordered list of categories
    ordered_categories = []
    for cat_id in sorting:
        if cat_id in categories:
            cat_data = categories[cat_id]
            ordered_categories.append({
                'id': cat_id,
                'label': cat_data.get('label', {}),
                'courses': cat_data.get('courses', []),
            })

    # Add any categories not in sorting list
    for cat_id, cat_data in categories.items():
        if cat_id not in sorting:
            ordered_categories.append({
                'id': cat_id,
                'label': cat_data.get('label', {}),
                'courses': cat_data.get('courses', []),
            })

    return ordered_categories
%></%def>


<%def name="get_fx_courses_by_category(all_courses, category_courses)" buffered="True"><%
    """
    Filter courses by category course IDs.
    Returns a list of courses that match the category's course_ids.
    """
    if not category_courses:
        return []

    # Convert category_courses to set for faster lookup
    category_course_set = set(category_courses)

    # Filter courses that are in the category
    filtered = []
    for course in all_courses:
        course_id = str(course.id)
        if course_id in category_course_set:
            filtered.append(course)

    return filtered
%></%def>

