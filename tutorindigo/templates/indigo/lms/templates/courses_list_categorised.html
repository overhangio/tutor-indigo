<%page args="fx_course_categories, section_id, section_title='', section_description=''" expression_filter="h"/>
<%namespace name='fx_static' file='fx_templates/fx_static_content.html'/>
<%! 
from django.utils.translation import gettext as _ 
from django.urls import reverse
%>

<%
import json

# 1. CATEGORY LOGIC
has_categories_with_courses = False
for cat in fx_course_categories:
    if cat.get('courses'):
        has_categories_with_courses = True
        break

no_courses = not fx_course_categories or not has_categories_with_courses

all_category_course_ids = set()
course_to_categories = {}
for cat in fx_course_categories:
    cat_id = cat.get('id', '')
    for cid in cat.get('courses', []):
        all_category_course_ids.add(cid)
        if cid not in course_to_categories:
            course_to_categories[cid] = []
        course_to_categories[cid].append(cat_id)

categories_json = {}
for cat in fx_course_categories:
    cat_id = cat.get('id', '')
    categories_json[cat_id] = cat.get('courses', [])

# Use provided title/description or defaults
display_title = fx_static.t(section_title) if section_title else _("Training courses")
display_description = fx_static.t(section_description) if section_description else _("We aim to enable individuals to achieve their full potential through high-quality education that is accessible to all.")
%>

<div class="fx-new-design-section" data-section-id="${section_id}">
    
    <div class="fx-section-header">
        <h2 class="fx-main-title">${display_title}</h2>
        <p class="fx-main-subtitle">${display_description}</p>
    </div>

    % if no_courses:
        <div class="fx-no-content">
            <h3>${_("There are no courses available at this time!")}</h3>
        </div>
    % elif settings.FEATURES.get('COURSES_ARE_BROWSABLE') and fx_course_categories:
        
        <div class="fx-tabs-wrapper">
            <div id="fx-tab-filter-${section_id}" class="fx-tabs-control">
                <button class="fx-tab-btn active" data-filter="all">${_("All Courses")}</button>
                % for category in fx_course_categories:
                    <%
                    cat_id = category.get('id', '')
                    cat_label = fx_static.t(category.get('label', {}))
                    cat_courses = category.get('courses', [])
                    %>
                    % if cat_label and cat_courses:
                        <button class="fx-tab-btn" data-filter="${cat_id}">${cat_label}</button>
                    % endif
                % endfor
            </div>
        </div>

        <div class="fx-grid-wrapper">
            <ul class="fx-custom-grid" id="fx-courses-grid-${section_id}">
                % for course in courses:
                    <%
                    course_id = str(course.id)
                    course_categories = course_to_categories.get(course_id, [])
                    categories_attr = ' '.join(course_categories)
                    
                    # Determine Course Link
                    course_target = reverse('about_course', args=[course_id])
                    
                    # Format Date
                    if course.start:
                        start_date_str = course.start.strftime('%B %d, %Y')
                    else:
                        start_date_str = _("Self-paced")
                    %>
                    
                    <li class="fx-card-item" data-course-id="${course_id}" data-categories="${categories_attr}">
                        <a href="${course_target}" class="fx-card-link">
                            <div class="fx-card-inner">
                                
                                <div class="fx-card-top">
                                    <div class="fx-card-logo">
                                        <img src="${course.course_image_url}" alt="${course.display_name_with_default}">
                                    </div>
                                    <h3 class="fx-card-heading">${course.display_name_with_default}</h3>
                                </div>

                                <div class="fx-card-meta">
                                    <div class="fx-meta-row">
                                        <span class="fx-icon">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M3 21h18M5 21V7l8-4 8 4v14M8 21v-8a2 2 0 012-2h4a2 2 0 012 2v8" />
                                            </svg>
                                        </span>
                                        <span class="fx-meta-text">${course.display_org_with_default}</span>
                                    </div>

                                    <div class="fx-meta-row">
                                        <span class="fx-icon">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                                <line x1="3" y1="10" x2="21" y2="10"></line>
                                            </svg>
                                        </span>
                                        <span class="fx-meta-text">${_("Start: ")} ${start_date_str}</span>
                                    </div>
                                </div>

                                <div class="fx-card-bottom">
                                    <span class="fx-more-text"><span class="fx-arrow">â€¹</span> ${_("More")}</span>
                                </div>
                            </div>
                        </a>
                    </li>
                % endfor
            </ul>
        </div>
    % endif
</div>

<style>
/* =========================================
   FX TOTAL REDESIGN - NO OPENEDX STYLES
   ========================================= */
:root {
    --fx-bg: #F5F5F7;
    --fx-card-bg: #FFFFFF;
    --fx-accent: #9471E8; /* Purple */
    --fx-text-head: #111827;
    --fx-text-body: #6B7280;
    --fx-border: #E5E7EB;
    --fx-radius: 12px;
}

/* 1. SECTION RESET */
.fx-new-design-section {
    background: var(--fx-bg) !important;
    padding: 60px 20px !important;
    width: 100% !important;
    box-sizing: border-box !important;
    font-family: 'Inter', -apple-system, sans-serif !important;
    border-radius: 16px !important;
}

/* 2. HEADER */
.fx-section-header {
    text-align: center !important;
    max-width: 700px !important;
    margin: 0 auto 50px auto !important;
}

.fx-main-title {
    font-size: 2.5rem !important;
    font-weight: 800 !important;
    color: #000 !important;
    margin-bottom: 15px !important;
    text-transform: none !important;
    border: none !important;
    -webkit-font-smoothing: antialiased !important;
    -moz-osx-font-smoothing: grayscale !important;
}

.fx-main-subtitle {
    font-size: 1.1rem !important;
    color: var(--fx-text-body) !important;
    line-height: 1.5 !important;
    -webkit-font-smoothing: antialiased !important;
    -moz-osx-font-smoothing: grayscale !important;
}

/* 3. TABS */
.fx-tabs-wrapper {
    display: flex !important;
    justify-content: center !important;
    margin-bottom: 50px !important;
}

.fx-tabs-control {
    display: inline-flex !important;
    background: #fff !important;
    border: 1px solid var(--fx-border) !important;
    border-radius: 6px !important;
    padding: 4px !important;
}

.fx-tab-btn {
    background: transparent !important;
    border: none !important;
    border-right: 1px solid var(--fx-border) !important;
    padding: 10px 30px !important;
    font-weight: 600 !important;
    color: #4B5563 !important;
    cursor: pointer !important;
    transition: background-color 0.2s, color 0.2s !important;
    outline: none !important;
    user-select: none !important;
    -webkit-tap-highlight-color: transparent !important;
    font-family: inherit !important;
    font-size: 0.95rem !important;
    line-height: 1 !important;
    margin: 0 !important;
    box-shadow: none !important;
    text-decoration: none !important;
    -webkit-appearance: none !important;
    -moz-appearance: none !important;
    appearance: none !important;
    text-shadow: none !important;
    -webkit-text-stroke: 0 !important;
}

.fx-tab-btn:focus,
.fx-tab-btn:active,
.fx-tab-btn:focus-visible {
    outline: none !important;
    box-shadow: none !important;
    border-color: var(--fx-border) !important;
}

.fx-tab-btn:hover:not(.active) {
    background: rgba(148, 113, 232, 0.1) !important;
}

.fx-tab-btn:last-child {
    border-right: none !important;
}

.fx-tab-btn.active {
    background: var(--fx-accent) !important;
    color: #fff !important;
    border-radius: 4px !important;
    border-color: var(--fx-accent) !important;
    outline: none !important;
    box-shadow: none !important;
}

/* 4. GRID */
.fx-grid-wrapper {
    max-width: 1200px !important;
    margin: 0 auto !important;
}

.fx-custom-grid {
    display: grid !important;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)) !important;
    gap: 30px !important;
    list-style: none !important;
    padding: 0 !important;
    margin: 0 !important;
}

/* 5. NEW CARD DESIGN (Pixel Perfect to Image) */
.fx-card-item {
    margin: 0 !important;
    padding: 0 !important;
    list-style: none !important;
    transition: all 0.3s ease !important;
}

.fx-card-link {
    text-decoration: none !important;
    color: inherit !important;
    display: block !important;
    height: 100% !important;
    outline: none !important;
    -webkit-tap-highlight-color: transparent !important;
}

.fx-card-link:focus {
    outline: none !important;
}

.fx-card-inner {
    background: #FFFFFF !important;
    border-radius: var(--fx-radius) !important;
    padding: 24px !important;
    display: flex !important;
    flex-direction: column !important;
    height: 100% !important;
    min-height: 220px !important;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05) !important;
    border: 1px solid transparent !important;
    transition: transform 0.2s, box-shadow 0.2s !important;
    box-sizing: border-box !important;
}

.fx-card-inner:hover {
    transform: translateY(-5px) !important;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04) !important;
}

/* Top Section: Logo + Title */
.fx-card-top {
    display: flex !important;
    align-items: flex-start !important;
    gap: 15px !important;
    margin-bottom: 25px !important;
}

.fx-card-logo {
    flex-shrink: 0 !important;
    width: 60px !important;
    height: 60px !important;
    border-radius: 8px !important;
    overflow: hidden !important;
    background: #f0f0f0 !important;
    border: 1px solid #eee !important;
}

.fx-card-logo img {
    width: 100% !important;
    height: 100% !important;
    object-fit: cover !important;
}

.fx-card-heading {
    font-size: 1.1rem !important;
    font-weight: 700 !important;
    color: var(--fx-text-head) !important;
    line-height: 1.3 !important;
    margin: 0 !important;
    padding: 0 !important;
    text-transform: none !important;
    letter-spacing: normal !important;
    -webkit-font-smoothing: antialiased !important;
    -moz-osx-font-smoothing: grayscale !important;
}

/* Middle: Meta */
.fx-card-meta {
    margin-bottom: 20px !important;
    flex-grow: 1 !important;
}

.fx-meta-row {
    display: flex !important;
    align-items: center !important;
    gap: 10px !important;
    margin-bottom: 12px !important;
    color: #555 !important;
}

.fx-icon {
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    color: #9CA3AF !important;
    width: 20px !important;
}

.fx-meta-text {
    font-size: 0.9rem !important;
    font-weight: 500 !important;
    color: #4B5563 !important;
}

/* Bottom: More Link */
.fx-card-bottom {
    text-align: right !important;
    margin-top: auto !important;
}

.fx-more-text {
    font-size: 0.95rem !important;
    color: #374151 !important;
    font-weight: 500 !important;
    display: inline-flex !important;
    align-items: center !important;
}

.fx-arrow {
    margin-right: 5px !important;
    font-size: 1.2rem !important;
    line-height: 0.8 !important;
    color: #9CA3AF !important;
}

/* Animation Utilities */
.fx-card-item.hidden {
    display: none !important;
}

.fx-fade-out {
    opacity: 0 !important;
    transform: scale(0.95) !important;
}

.fx-fade-in {
    opacity: 1 !important;
    transform: scale(1) !important;
}

/* Mobile */
@media (max-width: 768px) {
    .fx-tabs-control {
        flex-direction: column !important;
        width: 100% !important;
    }
    .fx-tab-btn {
        width: 100% !important;
        border-right: none !important;
        border-bottom: 1px solid var(--fx-border) !important;
    }
}
</style>

<script>
(function() {
    'use strict';

    var sectionId = '${section_id}';
    var section = document.querySelector('[data-section-id="' + sectionId + '"]');
    if (!section) return;

    var buttons = section.querySelectorAll('.fx-tab-btn');
    var courseItems = section.querySelectorAll('.fx-card-item');
    var categories = ${json.dumps(categories_json) | n};

    function filterCourses(filter) {
        // Tab State
        buttons.forEach(function(btn) {
            if(btn.dataset.filter === filter) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });

        // Grid Animation
        courseItems.forEach(function(item) {
            var courseId = item.dataset.courseId;
            var shouldShow = false;

            if (filter === 'all') {
                shouldShow = true;
            } else if (categories[filter] && categories[filter].indexOf(courseId) > -1) {
                shouldShow = true;
            }

            if (shouldShow) {
                item.classList.remove('hidden');
                void item.offsetWidth; // Reflow
                item.classList.remove('fx-fade-out');
                item.classList.add('fx-fade-in');
            } else {
                item.classList.add('fx-fade-out');
                setTimeout(function() {
                    item.classList.add('hidden');
                    item.classList.remove('fx-fade-in');
                }, 300);
            }
        });
    }

    buttons.forEach(function(btn) {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            filterCourses(this.dataset.filter);
        });
    });

    // Start with all courses
    filterCourses('all');
})();
</script>